<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>強化版チャットインターフェース - デイリーフォーチュン</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .chat-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
            background: linear-gradient(135deg, #fcf7ff 0%, #f6edff 100%);
        }
        
        .chat-header {
            background: linear-gradient(120deg, #9c27b0, #7b1fa2);
            color: white;
            padding: 16px;
            display: flex;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 15px rgba(0,0,0,0.15);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .back-button {
            background: none;
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            cursor: pointer;
        }
        
        .back-button:active {
            background-color: rgba(255,255,255,0.1);
        }
        
        .chat-title {
            flex-grow: 1;
            text-align: center;
            font-weight: 400;
            font-size: 1.3rem;
            letter-spacing: 0.5px;
        }
        
        .active-context-display {
            display: flex;
            align-items: center;
            margin-right: 16px;
            cursor: pointer;
        }
        
        .active-context-icon {
            position: relative;
            margin-right: 6px;
            display: flex;
            align-items: center;
        }
        
        .active-context-icon .icon-wrapper {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            position: relative;
        }
        
        .active-context-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: #4caf50;
            color: white;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid white;
        }
        
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        
        .message-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
        }
        
        .message {
            max-width: 80%;
            margin-bottom: 16px;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.user {
            align-self: flex-end;
            background-color: #9c27b0;
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .message.assistant {
            align-self: flex-start;
            background-color: white;
            color: #333;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }
        
        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 6px;
            text-align: right;
        }
        
        .input-container {
            padding: 12px 16px;
            background-color: white;
            display: flex;
            align-items: center;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
        }
        
        .context-action-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #9c27b0;
            position: relative;
        }
        
        .context-action-button:hover {
            background-color: rgba(156, 39, 176, 0.1);
        }
        
        /* マジックコンテキストボタンのスタイリング */
        .magic-context-button {
            overflow: hidden;
        }
        
        .magic-icon-wrapper {
            position: relative;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .magic-context-button .person-icon {
            color: #9c27b0;
            position: absolute;
            top: 0;
            left: 0;
            font-size: 20px;
            transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        
        .magic-context-button .add-icon {
            position: absolute;
            bottom: -3px;
            right: -3px;
            background-color: #4caf50;
            color: white;
            font-size: 12px;
            border-radius: 50%;
            padding: 2px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            transform: scale(1);
            transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        
        .magic-context-button:hover .person-icon {
            transform: scale(0.85);
        }
        
        .magic-context-button:hover .add-icon {
            transform: scale(1.2);
        }
        
        .message-input {
            flex-grow: 1;
            border: 1px solid #e0e0e0;
            border-radius: 24px;
            padding: 12px 16px;
            font-size: 16px;
            background-color: #f5f5f5;
            outline: none;
            resize: none;
            max-height: 100px;
            overflow-y: auto;
        }
        
        .message-input:focus {
            border-color: #9c27b0;
            background-color: white;
        }
        
        .send-button {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background-color: #9c27b0;
            color: white;
            border: none;
            margin-left: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .send-button:disabled {
            background-color: #e0e0e0;
            box-shadow: none;
            cursor: not-allowed;
        }
        
        /* Active Context Pills */
        .active-context-pills {
            padding: 8px 16px;
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(5px);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            transition: max-height 0.3s ease, padding 0.3s ease;
            max-height: 50px;
        }
        
        .active-context-pills.hidden {
            max-height: 0;
            padding: 0 16px;
            overflow: hidden;
        }
        
        .context-pill {
            display: flex;
            align-items: center;
            padding: 4px 12px;
            margin-right: 8px;
            border-radius: 16px;
            font-size: 13px;
            white-space: nowrap;
            background-color: white;
            border: 1px solid #e0e0e0;
            color: #616161;
        }
        
        .context-pill.active {
            background-color: #9c27b0;
            color: white;
            border: 1px solid #7b1fa2;
        }
        
        .context-pill i {
            font-size: 14px;
            margin-right: 4px;
        }
        
        .context-pill .remove {
            margin-left: 4px;
            font-size: 14px;
            cursor: pointer;
        }
        
        /* Context Menu */
        .context-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .context-menu.visible {
            transform: translateY(0);
        }
        
        .context-menu-handle {
            width: 40px;
            height: 5px;
            background-color: #e0e0e0;
            border-radius: 3px;
            margin: 12px auto;
        }
        
        .context-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 16px 16px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .context-menu-title {
            font-size: 18px;
            font-weight: 500;
            color: #212121;
        }
        
        .context-close-button {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 16px;
            background: none;
            border: none;
            color: #616161;
            cursor: pointer;
        }
        
        .context-close-button:hover {
            background-color: #f5f5f5;
        }
        
        .context-dialog-content {
            padding: 16px;
        }
        
        .context-section {
            margin-bottom: 24px;
        }
        
        .context-section-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #424242;
            display: flex;
            align-items: center;
        }
        
        .context-section-title i {
            margin-right: 8px;
        }
        
        .context-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .context-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            background-color: #f5f5f5;
            cursor: pointer;
            transition: background-color 0.2s;
            user-select: none;
        }
        
        .context-item:hover {
            background-color: #eee;
        }
        
        .context-item.selected {
            background-color: #e8f5e9;
            border: 1px solid #4caf50;
        }
        
        .context-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #9c27b0;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 16px;
        }
        
        .context-icon.friend {
            background-color: #2196f3;
        }
        
        .context-icon.team {
            background-color: #ff9800;
        }
        
        .context-info {
            flex-grow: 1;
        }
        
        .context-name {
            font-weight: 500;
            color: #212121;
        }
        
        .context-meta {
            font-size: 13px;
            color: #616161;
        }
        
        .context-element {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-top: 4px;
            font-weight: 500;
        }
        
        .element-wood {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .element-fire {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .element-earth {
            background-color: #fff8e1;
            color: #ff8f00;
        }
        
        .element-metal {
            background-color: #f5f5f5;
            color: #616161;
        }
        
        .element-water {
            background-color: #e3f2fd;
            color: #1565c0;
        }
        
        .context-action-buttons {
            display: flex;
            justify-content: flex-end;
            padding: 8px 16px 24px;
            border-top: 1px solid #f0f0f0;
            margin-top: 8px;
        }
        
        .context-action-button-text {
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s;
        }
        
        .context-action-button-text.cancel {
            background-color: transparent;
            color: #616161;
            margin-right: 8px;
        }
        
        .context-action-button-text.cancel:hover {
            background-color: #f5f5f5;
        }
        
        .context-action-button-text.apply {
            background-color: #9c27b0;
            color: white;
        }
        
        .context-action-button-text.apply:hover {
            background-color: #7b1fa2;
        }
        
        /* ツールチップ */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 160px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            text-align: center;
            padding: 8px;
            border-radius: 6px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            pointer-events: none;
        }
        
        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* アクティブなコンテキストのミニ表示 */
        .context-mini-preview {
            display: flex;
            position: absolute;
            bottom: 108%; /* 入力フォームの上に配置 */
            left: 16px;
            z-index: 10;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            padding: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            transition: opacity 0.3s, transform 0.3s;
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
        }
        
        .context-mini-preview.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        
        .mini-context-item {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin: 0 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f0f0f0;
            color: #616161;
            font-size: 16px;
            border: 2px solid white;
            position: relative;
        }
        
        .mini-context-item.user {
            background-color: #9c27b0;
            color: white;
        }
        
        .mini-context-item.friend {
            background-color: #2196f3;
            color: white;
        }
        
        .mini-context-item.day {
            background-color: #ff9800;
            color: white;
        }
        
        .mini-context-item.team {
            background-color: #4caf50;
            color: white;
        }
        
        .mini-context-plus {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin: 0 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #7b1fa2, #9c27b0);
            color: white;
            font-size: 16px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        /* キラキラエフェクト付きボタン */
        .sparkle-button {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .sparkle {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.8);
            opacity: 0;
            animation: sparkle-animation 3s ease-in-out infinite;
            box-shadow: 0 0 4px 1px rgba(255, 255, 255, 0.4);
        }
        
        .sparkle-1 {
            top: 15%;
            left: 15%;
            animation-delay: 0s;
        }
        
        .sparkle-2 {
            top: 60%;
            left: 70%;
            animation-delay: 0.6s;
        }
        
        .sparkle-3 {
            top: 70%;
            left: 20%;
            animation-delay: 1.2s;
        }
        
        @keyframes sparkle-animation {
            0%, 100% { opacity: 0; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.5); }
        }
        
        /* アクティブコンテキスト表示 */
        .context-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: flex-start;
            padding-top: 72px;
        }
        
        .context-overlay.visible {
            display: flex;
        }
        
        .context-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 400px;
            overflow: hidden;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .context-card-header {
            padding: 16px;
            background-color: #9c27b0;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .context-card-title {
            font-size: 18px;
            font-weight: 500;
        }
        
        .context-card-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
        }
        
        .context-card-close:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .context-card-content {
            padding: 16px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .active-context-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .active-context-item {
            display: flex;
            padding: 12px;
            border-radius: 8px;
            background-color: #f5f5f5;
            position: relative;
        }
        
        .active-context-item-badge {
            position: absolute;
            top: -4px;
            left: -4px;
            background-color: #9c27b0;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid white;
        }
        
        .active-context-details {
            flex: 1;
        }
        
        .active-context-title {
            font-weight: 500;
            margin-bottom: 4px;
            color: #212121;
            display: flex;
            align-items: center;
        }
        
        .active-context-title i {
            margin-right: 8px;
            font-size: 16px;
        }
        
        .active-context-content {
            font-size: 14px;
            color: #616161;
            line-height: 1.4;
        }
        
        .active-context-content p {
            margin-bottom: 8px;
        }
        
        .active-context-content p:last-child {
            margin-bottom: 0;
        }
        
        .active-context-actions {
            display: flex;
            margin-left: 8px;
        }
        
        .active-context-action {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: #9c27b0;
            cursor: pointer;
        }
        
        .active-context-action:hover {
            background-color: rgba(156, 39, 176, 0.1);
        }
        
        .active-context-action.remove {
            color: #f44336;
        }
        
        /* スマートポップオーバー（スイッチャー） */
        .smart-context-popover {
            position: absolute;
            left: 16px;
            bottom: 76px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            width: 260px;
            z-index: 200;
            display: none;
            animation: popUp 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        
        @keyframes popUp {
            from { transform: translateY(10px) scale(0.95); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        
        .smart-context-popover.visible {
            display: block;
        }
        
        .smart-context-popover::before {
            content: "";
            position: absolute;
            bottom: -8px;
            left: 20px;
            border-width: 8px 8px 0;
            border-style: solid;
            border-color: white transparent transparent;
        }
        
        .smart-context-tabs {
            display: flex;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .smart-context-tab {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            color: #616161;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        
        .smart-context-tab.active {
            color: #9c27b0;
            border-bottom-color: #9c27b0;
        }
        
        .smart-context-panels {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .smart-context-panel {
            display: none;
            padding: 12px;
        }
        
        .smart-context-panel.active {
            display: block;
        }
        
        .smart-context-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .smart-context-item:hover {
            background-color: #f5f5f5;
        }
        
        .smart-context-item-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
        }
        
        .smart-context-item-icon.user {
            background-color: #9c27b0;
            color: white;
        }
        
        .smart-context-item-icon.friend {
            background-color: #2196f3;
            color: white;
        }
        
        .smart-context-item-icon.day {
            background-color: #ff9800;
            color: white;
        }
        
        .smart-context-item-icon.team {
            background-color: #4caf50;
            color: white;
        }
        
        .smart-context-item-label {
            font-size: 14px;
            color: #212121;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- ヘッダー -->
        <div class="chat-header">
            <button class="back-button">
                <span class="material-icons">arrow_back</span>
            </button>
            <div class="chat-title">運勢相談</div>
            <div class="active-context-display" id="open-context-display">
                <div class="active-context-icon">
                    <div class="icon-wrapper">
                        <span class="material-icons">people</span>
                    </div>
                    <span class="active-context-badge">3</span>
                </div>
            </div>
        </div>
        
        <!-- アクティブなコンテキストピル -->
        <div class="active-context-pills" id="active-context-pills">
            <div class="context-pill active">
                <i class="material-icons">person</i>
                自分
            </div>
            <div class="context-pill">
                <i class="material-icons">today</i>
                今日の運勢
                <span class="material-icons remove">close</span>
            </div>
            <div class="context-pill">
                <i class="material-icons">people</i>
                田中さん
                <span class="material-icons remove">close</span>
            </div>
        </div>
        
        <!-- メインコンテンツ -->
        <div class="main-content">
            <div class="message-list">
                <!-- AIメッセージ -->
                <div class="message assistant">
                    <p>こんにちは。今日の運勢や個人的な質問について相談したいことがあれば、お気軽にお尋ねください。</p>
                    <div class="message-time">14:30</div>
                </div>
                
                <!-- ユーザーメッセージ -->
                <div class="message user">
                    <p>今日の仕事運はどうですか？</p>
                    <div class="message-time">14:31</div>
                </div>
                
                <!-- AIメッセージ -->
                <div class="message assistant">
                    <p>佐藤さんの今日の仕事運は好調です。四柱推命の分析によると、今日の日柱（戊子）はあなたの命式と相性が良く、特に金属の気が強まっています。</p>
                    <p>あなたの用神である「偏財」のエネルギーが活性化されているため、特に創造的な仕事や新しいアイデアの提案に適した日です。</p>
                    <p>今日のラッキーカラーは金属を象徴するシルバーやグレーなので、そういった色の小物を身につけると良いでしょう。</p>
                    <div class="message-time">14:32</div>
                </div>
                
                <!-- ユーザーメッセージ -->
                <div class="message user">
                    <p>田中さんとの相性はどうですか？</p>
                    <div class="message-time">14:33</div>
                </div>
                
                <!-- AIメッセージ -->
                <div class="message assistant">
                    <p>佐藤さんと田中さんの相性を分析しました。あなたの木の気に対して、田中さんは火の気が強い方ですね。これは基本的に相生（木が火を生む）の関係で、良好な相性です。</p>
                    <p>あなたの用神「偏財」と田中さんの元素特性を考慮すると、お互いに刺激し合い、創造的な協力関係が期待できます。特にプロジェクトの立案や新しいアイデアの創出で相乗効果が発揮されるでしょう。</p>
                    <p>ただし、田中さんの火のエネルギーがあなたの木のエネルギーを消費しすぎないよう、適度な距離感を保つことも時には必要です。</p>
                    <div class="message-time">14:34</div>
                </div>
            </div>
            
            <!-- アクティブなコンテキストのミニ表示 -->
            <div class="context-mini-preview" id="context-mini-preview">
                <div class="mini-context-item user">
                    <span class="material-icons">person</span>
                </div>
                <div class="mini-context-item day">
                    <span class="material-icons">today</span>
                </div>
                <div class="mini-context-item friend">
                    <span class="material-icons">face</span>
                </div>
                <div class="mini-context-plus" id="open-context-switcher">
                    <div class="sparkle-button">
                        <span class="material-icons">autorenew</span>
                        <div class="sparkle sparkle-1"></div>
                        <div class="sparkle sparkle-2"></div>
                        <div class="sparkle sparkle-3"></div>
                    </div>
                </div>
            </div>
            
            <!-- 入力エリア -->
            <div class="input-container">
                <div class="context-action-button tooltip magic-context-button" id="toggle-context-preview">
                    <div class="magic-icon-wrapper">
                        <span class="material-icons person-icon">person</span>
                        <span class="material-icons add-icon">add</span>
                    </div>
                    <span class="tooltip-text">コンテキスト情報を追加</span>
                </div>
                <textarea class="message-input" placeholder="メッセージを入力..."></textarea>
                <button class="send-button">
                    <span class="material-icons">send</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- スマートコンテキストポップオーバー -->
    <div class="smart-context-popover" id="smart-context-popover">
        <div class="smart-context-tabs">
            <div class="smart-context-tab active" data-tab="friends">友達</div>
            <div class="smart-context-tab" data-tab="fortune">運勢</div>
            <div class="smart-context-tab" data-tab="team">チーム</div>
        </div>
        <div class="smart-context-panels">
            <div class="smart-context-panel active" data-panel="friends">
                <div class="smart-context-item">
                    <div class="smart-context-item-icon friend">
                        <span class="material-icons">face</span>
                    </div>
                    <div class="smart-context-item-label">田中太郎</div>
                </div>
                <div class="smart-context-item">
                    <div class="smart-context-item-icon friend">
                        <span class="material-icons">face</span>
                    </div>
                    <div class="smart-context-item-label">鈴木花子</div>
                </div>
                <div class="smart-context-item">
                    <div class="smart-context-item-icon friend">
                        <span class="material-icons">face</span>
                    </div>
                    <div class="smart-context-item-label">山田健太</div>
                </div>
            </div>
            <div class="smart-context-panel" data-panel="fortune">
                <div class="smart-context-item">
                    <div class="smart-context-item-icon day">
                        <span class="material-icons">today</span>
                    </div>
                    <div class="smart-context-item-label">今日の運勢</div>
                </div>
                <div class="smart-context-item">
                    <div class="smart-context-item-icon day">
                        <span class="material-icons">event</span>
                    </div>
                    <div class="smart-context-item-label">明日の運勢</div>
                </div>
                <div class="smart-context-item">
                    <div class="smart-context-item-icon day">
                        <span class="material-icons">calendar_month</span>
                    </div>
                    <div class="smart-context-item-label">今週の運勢</div>
                </div>
            </div>
            <div class="smart-context-panel" data-panel="team">
                <div class="smart-context-item">
                    <div class="smart-context-item-icon team">
                        <span class="material-icons">groups</span>
                    </div>
                    <div class="smart-context-item-label">開発チーム</div>
                </div>
                <div class="smart-context-item">
                    <div class="smart-context-item-icon team">
                        <span class="material-icons">flag</span>
                    </div>
                    <div class="smart-context-item-label">プロジェクト目標</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- アクティブコンテキスト表示オーバーレイ -->
    <div class="context-overlay" id="context-overlay">
        <div class="context-card">
            <div class="context-card-header">
                <div class="context-card-title">現在のコンテキスト情報</div>
                <button class="context-card-close" id="close-context-overlay">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="context-card-content">
                <div class="active-context-list">
                    <!-- ユーザー自身の情報 -->
                    <div class="active-context-item">
                        <span class="active-context-item-badge">1</span>
                        <div class="active-context-details">
                            <div class="active-context-title">
                                <i class="material-icons">person</i>
                                ユーザー情報
                            </div>
                            <div class="active-context-content">
                                <p><strong>名前:</strong> 佐藤健太</p>
                                <p><strong>五行属性:</strong> 木</p>
                                <p><strong>日主:</strong> 甲</p>
                                <p><strong>格局:</strong> 從旺格（身強）</p>
                                <p><strong>用神:</strong> 偏財（金）</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 日運情報 -->
                    <div class="active-context-item">
                        <span class="active-context-item-badge">2</span>
                        <div class="active-context-details">
                            <div class="active-context-title">
                                <i class="material-icons">today</i>
                                今日の運勢
                            </div>
                            <div class="active-context-content">
                                <p><strong>日付:</strong> 2025年4月23日</p>
                                <p><strong>日柱:</strong> 戊子</p>
                                <p><strong>運勢スコア:</strong> 78/100</p>
                                <p><strong>ラッキーカラー:</strong> シルバー</p>
                            </div>
                        </div>
                        <div class="active-context-actions">
                            <button class="active-context-action remove">
                                <span class="material-icons">delete</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 友達情報 -->
                    <div class="active-context-item">
                        <span class="active-context-item-badge">3</span>
                        <div class="active-context-details">
                            <div class="active-context-title">
                                <i class="material-icons">people</i>
                                田中太郎
                            </div>
                            <div class="active-context-content">
                                <p><strong>五行属性:</strong> 火</p>
                                <p><strong>日主:</strong> 丙</p>
                                <p><strong>相性スコア:</strong> 78/100</p>
                                <p><strong>関係性:</strong> 相生（木が火を生む）</p>
                            </div>
                        </div>
                        <div class="active-context-actions">
                            <button class="active-context-action remove">
                                <span class="material-icons">delete</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // デバッグ用：即時実行関数
        console.log('スクリプト開始');
        
        // 即時実行モード（ページロード後すぐに実行）
        (function() {
            // コンテキストのプレビュー表示切り替え
            const toggleContextPreview = document.getElementById('toggle-context-preview');
            const contextMiniPreview = document.getElementById('context-mini-preview');
            
            // 新しいアイコンのために子要素も含めてイベントを捕捉
            if (toggleContextPreview) {
                toggleContextPreview.addEventListener('click', () => {
                    contextMiniPreview.classList.toggle('visible');
                });
                
                // 子要素のクリックでも親要素のクリックイベントを発火
                const children = toggleContextPreview.querySelectorAll('*');
                children.forEach(child => {
                    child.addEventListener('click', (e) => {
                        contextMiniPreview.classList.toggle('visible');
                        e.stopPropagation();
                    });
                });
            }
            
            // コンテキストピル表示の切り替え
            const openContextDisplay = document.getElementById('open-context-display');
            const activeContextPills = document.getElementById('active-context-pills');
            
            if (openContextDisplay) {
                openContextDisplay.addEventListener('click', () => {
                    activeContextPills.classList.toggle('hidden');
                    // コンテキストオーバーレイの表示
                    document.getElementById('context-overlay').classList.add('visible');
                });
            }
            
            // コンテキストオーバーレイを閉じる
            const closeOverlay = document.getElementById('close-context-overlay');
            if (closeOverlay) {
                closeOverlay.addEventListener('click', () => {
                    document.getElementById('context-overlay').classList.remove('visible');
                });
            }
            
            // スマートコンテキストスイッチャーを開く
            const openContextSwitcher = document.getElementById('open-context-switcher');
            if (openContextSwitcher) {
                openContextSwitcher.addEventListener('click', (e) => {
                    const popover = document.getElementById('smart-context-popover');
                    popover.classList.toggle('visible');
                    e.stopPropagation();
                });
                
                // キラキラボタンの子要素もクリックイベントをサポート
                const sparkleElements = openContextSwitcher.querySelectorAll('*');
                sparkleElements.forEach(elem => {
                    elem.addEventListener('click', (e) => {
                        const popover = document.getElementById('smart-context-popover');
                        popover.classList.toggle('visible');
                        e.stopPropagation();
                    });
                });
            }
            
            // スマートコンテキストのタブ切り替え
            const contextTabs = document.querySelectorAll('.smart-context-tab');
            
            contextTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // タブのアクティブ状態を切り替え
                    contextTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // 対応するパネルを表示
                    const targetPanel = tab.getAttribute('data-tab');
                    document.querySelectorAll('.smart-context-panel').forEach(panel => {
                        panel.classList.remove('active');
                    });
                    document.querySelector(`.smart-context-panel[data-panel="${targetPanel}"]`).classList.add('active');
                });
            });
            
            // 画面のどこかをクリックしたらポップオーバーを閉じる
            document.addEventListener('click', (e) => {
                const popover = document.getElementById('smart-context-popover');
                const switcher = document.getElementById('open-context-switcher');
                
                if (popover.classList.contains('visible') && 
                    !popover.contains(e.target) && 
                    !switcher.contains(e.target)) {
                    popover.classList.remove('visible');
                }
                
                // ミニプレビューも閉じる（トグルボタン以外をクリックした場合）
                if (contextMiniPreview.classList.contains('visible') && 
                    !toggleContextPreview.contains(e.target) && 
                    !contextMiniPreview.contains(e.target)) {
                    contextMiniPreview.classList.remove('visible');
                }
            });
            
            // スマートコンテキストアイテムがクリックされたとき
            document.querySelectorAll('.smart-context-item').forEach(item => {
                item.addEventListener('click', () => {
                    // 選択されたコンテキストを追加する処理
                    
                    // ポップオーバーを閉じる
                    document.getElementById('smart-context-popover').classList.remove('visible');
                    
                    // ミニプレビューを閉じる
                    contextMiniPreview.classList.remove('visible');
                    
                    // デモ用に通知を表示
                    alert('コンテキストが追加されました！');
                });
            });
            
            // 削除ボタンの動作
            document.querySelectorAll('.active-context-action.remove').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // 親のコンテキストアイテムを取得
                    const contextItem = btn.closest('.active-context-item');
                    
                    // アニメーションでフェードアウト
                    contextItem.style.transition = 'opacity 0.3s, transform 0.3s';
                    contextItem.style.opacity = '0';
                    contextItem.style.transform = 'translateX(20px)';
                    
                    // アニメーション後に要素を削除
                    setTimeout(() => {
                        contextItem.remove();
                        
                        // バッジの数字を更新
                        updateBadgeCount();
                    }, 300);
                });
            });
            
            // コンテキストピルの削除ボタン
            document.querySelectorAll('.context-pill .remove').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const pill = btn.closest('.context-pill');
                    
                    // アニメーションでフェードアウト
                    pill.style.transition = 'opacity 0.3s, transform 0.3s';
                    pill.style.opacity = '0';
                    pill.style.transform = 'translateX(20px)';
                    
                    // アニメーション後に要素を削除
                    setTimeout(() => {
                        pill.remove();
                        
                        // バッジの数字を更新
                        updateBadgeCount();
                    }, 300);
                });
            });
            
            // バッジカウントを更新する関数
            function updateBadgeCount() {
                const pillCount = document.querySelectorAll('.context-pill').length;
                
                // ヘッダーのバッジを更新
                const badge = document.querySelector('.active-context-badge');
                if (badge) {
                    badge.textContent = pillCount;
                    
                    // バッジの数字に応じて表示/非表示
                    if (pillCount <= 1) {
                        badge.style.display = 'none';
                    } else {
                        badge.style.display = 'flex';
                    }
                }
            }
            
            // 初期化時にバッジカウントを更新
            updateBadgeCount();
            
            // デバッグ用：要素が見つかったか確認
            console.log('要素確認:', {
                togglePreview: toggleContextPreview ? 'あり' : 'なし',
                miniPreview: contextMiniPreview ? 'あり' : 'なし',
                openSwitcher: document.getElementById('open-context-switcher') ? 'あり' : 'なし',
                smartPopover: document.getElementById('smart-context-popover') ? 'あり' : 'なし'
            });
            
            // 要素がある場合は可視化（デバッグ用）
            if (contextMiniPreview) {
                // デバッグ用：自動的に表示
                contextMiniPreview.classList.add('visible');
                console.log('ミニプレビューを表示しました');
            }
        })();
    </script>
</body>
</html>