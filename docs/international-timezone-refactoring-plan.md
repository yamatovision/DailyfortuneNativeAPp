# 国際時差計算システム再構築計画

## 1. 現状の問題点

現在の時差計算システムには以下の構造的な問題が存在しています：

### 1.1 パッケージ構造の問題
- **sajuengine_package** が独立パッケージとして実装されているが、server側との連携に問題がある
- ビルドプロセスが分離されており、サーバービルド時に sajuengine_package の変更が反映されない
- 相対パスによる参照（`../../../../sajuengine_package/dist/international`）が信頼性に欠ける

### 1.2 実装上の問題
- SimplifiedTimeZoneManager クラスの実装は完了しているが、サーバー側からうまく参照できていない
- パッケージ間の依存関係が複雑で、変更時の影響範囲が把握しづらい
- コンパイル時は問題なくても実行時にモジュール解決に失敗する場合がある

### 1.3 APIエンドポイントの問題
- `/api/v1/day-pillars/available-cities` が旧実装を使用しており、新しい形式のレスポンスを返せていない
- サーバー上での変更が検出されても、深い依存関係のある部分は更新されない

## 2. 解決策

### 2.1 短期的解決策（タスクリスト）
1. **サーバー側で都道府県リストをハードコード**
   - 新しい SimplifiedTimeZoneManager を使用せず、サーバー側で都道府県リストと調整値を直接定義
   - 互換性のために `cities` フィールドも返しつつ、新しい `locations` と `categories` も提供

2. **getTimezoneInfo API の直接実装**
   - サーバー側で調整値を直接計算し、SimplifiedTimeZoneManager への依存を減らす

### 2.2 中長期的解決策
1. **パッケージ構造の再設計**
   - sajuengine_package をサーバープロジェクト内に統合するか、適切な依存関係として管理
   - 共有モジュールとして再構成し、一元的なビルドプロセスを確立

2. **ビルドプロセスの統合**
   - 単一のビルドコマンドで両方のコードベースをビルドできるようにする
   - サーバーのビルド前に自動的に sajuengine_package をビルドする仕組みを追加

3. **テスト強化**
   - 統合テストでパッケージ間の連携を検証
   - 実際の環境に近いテスト環境で動作確認

## 3. 実装計画

### 段階1: 緊急対応（当面の作業）
- サーバー側で `day-pillar.controller.ts` の `getAvailableCities` メソッドを独立実装に置き換え
- ハードコードされた都道府県リストと調整値を使用
- フロントエンド側で新しいAPIレスポンス形式に対応

### 段階2: パッケージ構造見直し
- sajuengine_package の依存関係とインポート方法を見直し
- より信頼性の高いモジュール間連携の実装

### 段階3: 完全リファクタリング
- 改良されたパッケージ構造への移行
- 全体的なコードベースのクリーンアップ

## 4. リファクタリング作業の注意点

- パッケージ間の依存関係を明示的に管理する
- 相対パスの過剰な使用を避け、より信頼性の高いインポート方法を採用
  - 直接的な相対パス参照（`import ... from '../../sajuengine_package/src'`）ではなくnpmパッケージ形式（`import ... from 'saju-engine'`）を使用
- フルリビルドのプロセスを整備し、変更が確実に反映される仕組みを構築
  - `clean-rebuild.sh`スクリプトでキャッシュやdistディレクトリを完全に削除してから再ビルド
- TypeScriptの設定（tsconfig.json）でパスエイリアスを適切に設定

## 5. 実装状況と完了内容（2025/4/19更新）

### 5.1 実装済み内容
- SimplifiedTimeZoneManager クラスの実装
- SimplifiedDateTimeProcessor クラスの実装
- DateTimeProcessorWrapper による互換性維持
- サーバー側のSajuEngineServiceとDay-pillarControllerの更新
- モジュール参照方法の改善（相対パスからnpmパッケージ形式に変更）
- クリーンビルドスクリプトの作成と動作確認

### 5.2 解決済みの課題
- APIエンドポイント `/api/v1/day-pillars/available-cities` が新しい形式（locationsとcategories）のレスポンスを返すように修正
- モジュールの読み込みパス解決問題を、npmパッケージ形式のインポートに移行することで解決
- ビルドプロセスやキャッシュの問題は、クリーンビルドスクリプトの実装により解決

### 5.3 今後の対応方針
1. **テスト強化**:
   - サービス層とコントローラー層の単体テスト実装
   - API統合テストの実装
   - エッジケースのテスト追加

2. **フロントエンド連携**:
   - 新しいAPIレスポンス形式をフロントエンドで正しく処理できるよう実装・テスト
   - 国際時間対応UIコンポーネントの開発

3. **ドキュメント整備**:
   - 新しい時差計算方式の詳細な説明ドキュメント作成
   - 開発者向けAPIリファレンス更新