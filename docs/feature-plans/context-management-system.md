# 機能変更計画書: チャットコンテキスト管理システム

## 1. ユーザーの要望

現在のチャットシステムでは、「個人運勢」「チームメンバー相性」「チーム目標」の3種類のモードを切り替えて使用するようになっています。しかし、このシステムでは同時に複数のコンテキスト情報を利用できないため、例えば「特定の友人と自分の今日の運勢を考慮した相性」などの複合的な質問に対応できません。

より柔軟で使いやすいチャットコンテキスト管理システムを実装し、ユーザーが必要な情報（自分の運勢、友達の情報など）を自由に組み合わせて会話できるようにしたいというご要望です。既存のモード切り替え方式は完全に廃止し、新しいコンテキスト管理システムに一本化します。ただし、ユーザー自身の四柱推命情報と今日の日柱情報は常に基本コンテキストとして自動設定され、他のコンテキスト情報は自由に追加・削除できるようにします。

## 2. 現状と課題

現在のチャットシステムは、次の特徴と制約があります：

1. **モード切替型の設計**：
   - 3つのモード（個人運勢、チームメンバー相性、チーム目標）を排他的に切り替える
   - モードごとに別々のチャット履歴が生成される
   - 各モードで固定的なコンテキスト情報のみが使用される

2. **限定的なコンテキスト組み合わせ**：
   - 「自分の情報」と「今日の運勢」は個人モードでのみ組み合わせ可能
   - 「自分の情報」と「チームメンバーの情報」は相性モードでのみ組み合わせ可能
   - 「自分の情報」と「チーム目標」はチーム目標モードでのみ組み合わせ可能

3. **コンテキスト情報の固定的な添付**：
   - モード選択時にコンテキスト情報が固定され、以降のすべてのメッセージに同じコンテキストが添付される
   - 会話の途中でコンテキスト情報を柔軟に追加/削除できない
   - ユーザーが必要とする組み合わせのコンテキストを自由に選択できない

4. **実装上の課題**：
   - `ChatMode` という列挙型に基づいた排他的設計
   - コンテキスト情報の構築はサーバー側で行われ、モードに応じて固定の情報を提供
   - チャット履歴はモードごとに独立しており、コンテキスト情報の組み合わせによる再利用ができない

## 3. 理想的なデータモデル設計

新しいチャットコンテキスト管理システムでは、より柔軟で拡張性のあるデータモデルが必要です。

### 3.1. クライアント側のデータモデル

```typescript
// コンテキスト情報アイテムの基本型
interface ContextItem {
  id: string;         // 一意のID
  type: ContextType;  // 情報の種類（自分、友達、運勢等）
  name: string;       // 表示名（「自分」「田中さん」「今日の運勢」等）
  iconType: string;   // アイコン種類（material-iconsのアイコン名）
  color: string;      // 表示色（コンテキストタイプ別のカラーコード）
  removable: boolean; // 削除可能かどうか（自分の情報は削除不可）
  payload: any;       // 実際のデータペイロード
}

// コンテキストタイプの列挙型
enum ContextType {
  SELF = 'self',         // 自分の情報
  FRIEND = 'friend',     // 友達の情報
  FORTUNE = 'fortune',   // 運勢情報
}

// チャット状態管理のインターフェース
interface ChatState {
  messages: ChatMessage[];
  activeContexts: ContextItem[]; // 現在有効なコンテキスト情報のリスト
  isLoading: boolean;
}

// APIリクエスト用のコンテキスト情報型
interface ChatContextRequest {
  contextItems: {
    type: ContextType;
    id?: string;        // 友達ID、運勢タイプ（today/tomorrow）など
    additionalInfo?: any; // 追加情報（必要に応じて）
  }[];
}

// 友達コンテキスト情報の詳細データ構造
interface FriendContextInfo {
  // 必須情報
  id: string;
  displayName: string;
  elementAttribute?: string;  // 五行属性
  dayMaster?: string;         // 日主
  pillars?: any;              // 四柱情報

  // 詳細情報
  jobTitle?: string;         // 役職・役割
  kakukyoku?: {              // 格局情報
    type: string;
    category: 'special' | 'normal';
    strength: 'strong' | 'weak' | 'neutral';
    description?: string;
  };
  yojin?: {                  // 用神情報
    tenGod: string;
    element: string;
    description?: string;
    supportElements?: string[];
    kijin?: any;
    kijin2?: any;
    kyujin?: any;
  };
  elementProfile?: {         // 五行バランス情報
    wood: number;
    fire: number;
    earth: number;
    metal: number;
    water: number;
  };
}
```

### 3.2. サーバー側のデータモデル

```typescript
// ChatHistoryモデルの拡張
interface IChatHistoryDocument extends Document {
  userId: Types.ObjectId;
  messages: {
    sender: 'user' | 'ai';
    content: string;
    timestamp: Date;
    contextItems?: {   // メッセージごとのコンテキスト情報
      type: string;   // コンテキストの種類
      refId?: string; // 参照ID（友達ID、運勢タイプなど）
      data?: any;     // 追加データ（必要に応じて）
    }[];
  }[];
  lastMessageAt: Date;
}
```

## 4. API設計

新しいチャットコンテキスト管理システムでは、既存のAPIエンドポイントを刷新し、コンテキストベースの新しいエンドポイントを実装します。

### 4.1. 新しいAPIエンドポイント

1. **メッセージ送信**
   ```
   POST /api/v1/chat/message
   ```
   - 必須パラメータ: `message`, `contextItems` (コンテキスト情報のリスト)
   
   リクエスト例:
   ```json
   {
     "message": "田中さんと今日の相性はどうですか？",
     "contextItems": [
       {
         "type": "friend",
         "id": "60a3e5c67f4d2b001c3e5c67"
       },
       {
         "type": "fortune",
         "id": "today"
       }
     ]
   }
   ```

   注: `self`タイプのコンテキスト（ユーザー自身の情報と今日の日柱情報）は自動的に追加されるため、明示的に指定する必要はありません。

2. **利用可能なコンテキスト情報取得**
   ```
   GET /api/v1/chat/contexts/available
   ```
   - ユーザーにとって利用可能な全てのコンテキスト情報を返す
   - 友達リスト、運勢情報など
   
   レスポンス例:
   ```json
   {
     "success": true,
     "availableContexts": {
       "self": {
         "id": "current_user",
         "name": "自分",
         "iconType": "person",
         "color": "#9c27b0"
       },
       "fortune": [
         {
           "id": "today",
           "name": "今日の運勢",
           "iconType": "today",
           "color": "#ff9800"
         },
         {
           "id": "tomorrow",
           "name": "明日の運勢",
           "iconType": "event",
           "color": "#ff9800"
         }
       ],
       "friends": [
         {
           "id": "60a3e5c67f4d2b001c3e5c67",
           "name": "田中太郎",
           "iconType": "face",
           "color": "#2196f3",
           "elementAttribute": "fire"
         }
       ]
     }
   }
   ```

3. **コンテキスト情報詳細取得**
   ```
   GET /api/v1/chat/contexts/detail?type={type}&id={id}
   ```
   - 指定されたコンテキスト情報の詳細を返す
   - 例: 特定の友達の詳細情報、特定の運勢情報の詳細など
   
   レスポンス例 (友達の場合):
   ```json
   {
     "success": true,
     "context": {
       "id": "60a3e5c67f4d2b001c3e5c67",
       "type": "friend",
       "name": "田中太郎",
       "iconType": "face",
       "color": "#2196f3",
       "payload": {
         "displayName": "田中太郎",
         "elementAttribute": "fire",
         "dayMaster": "丙",
         "kakukyoku": {
           "type": "從旺格",
           "category": "normal",
           "strength": "strong",
           "description": "日主が強く、印星が用神となる格局"
         },
         "yojin": {
           "tenGod": "比肩",
           "element": "fire",
           "description": "同じ属性の力を借りるとよい"
         },
         "elementProfile": {
           "wood": 2,
           "fire": 5,
           "earth": 1,
           "metal": 0,
           "water": 2
         },
         "jobTitle": "エンジニア"
       }
     }
   }
   ```

4. **チャット履歴取得**
   ```
   GET /api/v1/chat/history
   ```
   - 単一のチャット履歴を返す（モードによる分離なし）
   
   レスポンス例:
   ```json
   {
     "success": true,
     "history": {
       "messages": [
         {
           "sender": "assistant",
           "content": "こんにちは。今日の運勢や個人的な質問について相談したいことがあれば、お気軽にお尋ねください。",
           "timestamp": "2025-04-23T05:30:00.000Z"
         },
         {
           "sender": "user",
           "content": "田中さんとの相性はどうですか？",
           "timestamp": "2025-04-23T05:31:00.000Z",
           "contextItems": [
             { "type": "self", "id": "current_user" },
             { "type": "friend", "id": "60a3e5c67f4d2b001c3e5c67" }
           ]
         }
       ]
     }
   }
   ```

5. **チャット履歴クリア**
   ```
   DELETE /api/v1/chat/history
   ```
   - 全チャット履歴をクリア（単一履歴のため、モード指定不要）

## 5. UI/UX設計方針と機能フロー

モックアップを参考に、柔軟でユーザーフレンドリーな操作性とデータフローを実現します。

### 5.1. UI要素

1. **コンテキストピル表示**
   - 現在有効なコンテキスト情報をタグ形式（ピル）で画面上部に表示
   - ユーザー自身の情報は常に表示され、削除不可
   - その他のコンテキスト情報はユーザーが追加・削除可能

2. **コンテキスト追加UI**
   - 入力欄左側にコンテキスト追加ボタンを配置
   - タップするとミニプレビューが表示され、詳細メニューを開ける
   - カテゴリ分けされたメニューから選択（友達、運勢など）

3. **コンテキスト詳細表示**
   - ヘッダー右上のコンテキストアイコンをタップして詳細を表示
   - 現在有効なすべてのコンテキスト情報の詳細を確認可能
   - コンテキスト情報の削除も可能

4. **視覚的フィードバック**
   - コンテキストタイプごとに異なる色とアイコンを使用
   - バッジ数で現在のコンテキスト数を表示
   - アニメーションで操作の反応性を向上

### 5.2. 動作フロー

1. **コンテキスト選択フロー**
   - ユーザーがコンテキスト追加ボタンをタップ
   - カテゴリ別メニューから特定の情報（友達、運勢など）を選択
   - 選択された情報がコンテキストピルとして画面上部に追加
   - 複数のコンテキスト情報を追加することが可能

2. **メッセージ送信フロー**
   - ユーザーがメッセージを入力して送信
   - **メッセージと共に現在有効なすべてのコンテキスト情報がサーバーに送信**
   - サーバーはコンテキスト情報を解析し、AIプロンプトに統合
   - AIがコンテキスト情報を考慮した回答を生成
   - 生成された回答がユーザーに表示

3. **コンテキスト変更フロー**
   - 会話の途中でもコンテキスト情報を追加・削除可能
   - コンテキスト情報を変更した後のメッセージには、更新されたコンテキスト情報が添付
   - 以前のメッセージには影響せず、各メッセージは送信時のコンテキスト情報に基づいて処理

## 6. システムプロンプトの改訂

新しいチャットコンテキスト管理システムに対応したシステムプロンプトを以下のように定義します：

```typescript
export const CHAT_SYSTEM_PROMPT = `
あなたは四柱推命の第一人者として、占術に基づいた運勢予測と人間関係の洞察を提供する専門家です。「デイリーフォーチュン」のプラットフォームを通じて、提供されたコンテキスト情報を活用して専門的アドバイスを提供します。

会話において遵守すべき原則：

1. 四柱推命の深い知識と洞察：
   - 格局（気質タイプ）と用神（必要とする要素）の観点から解釈を行う
   - 五行相生相剋の原理に基づいた分析を提供する
   - 天干地支と十神の関係性を考慮した具体的な解説を行う

2. コンテキスト情報の徹底活用：
   - 常に含まれるユーザーの命式（四柱、格局、用神、五行バランス）を基本分析
   - 含まれる日柱情報との相互作用を詳細に検討
   - 他のコンテキスト（友人情報など）が提供された場合は、それらの情報も総合的に分析

3. 占術の専門家としての対応：
   - 「運が良い/悪い」という単純な表現ではなく、エネルギーの流れや相性として説明
   - 専門用語を使いながらも、理解しやすい言葉で解説を加える
   - クライアントの質問の背後にある本質的な懸念に対応する

4. コンテキストに応じた専門的アプローチ：
   - 「今日の運勢」を含む場合: 命式と日柱の相互作用に基づいた具体的なアドバイスを提供
   - 友人のコンテキストを含む場合: 両者の命式を分析し、相性や相互作用を解説
   - 複数のコンテキストを含む場合: それらの組み合わせから生じる特別な意味や影響を考慮

常に、提供されたコンテキスト情報を最大限に活用し、四柱推命の専門家として深みのある実用的なアドバイスを提供してください。コンテキスト情報にない要素については推測せず、与えられた情報の範囲内で最善の分析を行ってください。
`;
```

## 7. 設計原則の適用

新しいシステムは次の設計原則に基づいて実装します。

1. **単一責任原則**
   - コンテキスト管理、チャットメッセージ処理、UIコンポーネントの責任を明確に分離
   - 各コンポーネントが1つの責任のみを持つよう設計

2. **関心の分離**
   - データの取得・管理とUIの表示を分離
   - コンテキスト情報の管理とチャットメッセージの処理を分離

3. **適切な抽象化**
   - コンテキスト情報の抽象化により、新しいコンテキストタイプの追加を容易に
   - UIコンポーネントの抽象化により、再利用性を向上

## 8. 修正が必要な関連ファイル一覧

### クライアント側
- `client/src/components/chat/ChatContainer.tsx`: コンテキスト管理機能の統合と既存モード選択機能の削除
- `client/src/components/chat/ChatInput.tsx`: コンテキスト追加ボタンの実装
- `client/src/components/chat/ChatModeSelector.tsx`: **完全削除**（代わりに新しいコンテキスト管理UIに置き換え）
- `client/src/components/chat/ChatMessageList.tsx`: メッセージ表示の最適化
- `client/src/pages/Chat/index.tsx`: コンテキスト管理UIの統合
- `client/src/services/chat.service.ts`: APIリクエストの刷新（モードベースから完全にコンテキストベースへ）

### 新規作成ファイル（クライアント側）
- `client/src/components/chat/ChatContextManager.tsx`: コンテキスト管理コンポーネント
- `client/src/components/chat/ChatContextSelector.tsx`: コンテキスト選択UI
- `client/src/components/chat/ChatContextDisplay.tsx`: コンテキスト情報表示
- `client/src/components/chat/ChatContextPills.tsx`: コンテキストピル表示
- `client/src/services/context.service.ts`: コンテキスト情報管理サービス

### サーバー側
- `server/src/controllers/chat.controller.ts`: 新しいコンテキストベースAPIの実装、モードベースAPIの削除
- `server/src/models/ChatHistory.ts`: データモデルの刷新（モード分割なしの単一履歴）
- `server/src/services/chat/chat.service.ts`: コンテキスト処理ロジックの刷新
- `server/src/services/chat/context-builder.service.ts`: 柔軟なコンテキスト構築機能の実装
- `server/src/services/chat/chat-contexts.ts`: コンテキスト別プロンプトの拡張

### 共有型定義
- `shared/index.ts`: `ChatMode`列挙型の削除と新しいコンテキスト関連の型定義の追加

## 9. コンテキスト形成に役立つファイル一覧

- `client/src/components/chat/ChatContainer.tsx`: 現在のチャットコンテナ実装
- `client/src/services/chat.service.ts`: 現在のチャットAPIとの通信
- `server/src/services/chat/context-builder.service.ts`: 現在のコンテキスト構築ロジック
- `server/src/services/chat/chat-contexts.ts`: 現在のプロンプトテンプレート
- `client/src/services/friend.service.ts`: 友達情報の取得処理

## 10. 修正するAIへの引き継ぎ事項

1. **完全な刷新アプローチ**
   - 既存のモードベースのチャットシステムは完全に削除し、新しいコンテキストベースのシステムに置き換える
   - `ChatMode`列挙型および関連する実装は全て削除する
   - ユーザーの四柱推命情報と今日の日柱情報は常に基本コンテキストとして自動設定する（UI上で削除不可）

2. **段階的実装方針**
   - まずはクライアント側のUIとデータ構造の変更を実装
   - 次にサーバー側のAPI刷新とコンテキスト処理ロジックを実装
   - 最後に既存のモードベースコードを完全に削除

3. **注意点**
   - チャット履歴のデータ構造が大幅に変更されるため、既存データの移行か新規作成が必要
   - コンテキスト情報の組み合わせによるプロンプト生成ロジックの実装が重要
   - パフォーマンスへの影響（多数のコンテキスト情報処理時）

4. **モックアップとの一致**
   - UIはモックアップに忠実に実装すること
   - アニメーションや視覚的フィードバックも重要な要素として実装

## 11. 修正を実行するためのタスクリスト

1. **データモデルの刷新**
   - 共有型定義の更新（`shared/index.ts`）- `ChatMode`列挙型の削除と新型定義の追加
   - クライアント側の状態管理構造の実装
   - サーバー側のデータモデル刷新（`ChatHistory`モデルの更新）

2. **クライアント側のUI実装**
   - コンテキストピル表示コンポーネントの作成
   - コンテキスト追加ボタンとメニューの実装
   - コンテキスト詳細表示モーダルの実装
   - `ChatModeSelector`の削除と新UIへの置き換え

3. **サーバー側のロジック実装**
   - モードベースのコード削除
   - コンテキスト構築ロジックの実装
   - 新しいAPIエンドポイントの実装
   - プロンプト生成ロジックの実装

4. **コンテキスト情報の実装詳細**
   - 自分のコンテキスト（必須・削除不可）
     - 四柱推命情報（五行属性、日主、格局、用神）
     - ユーザー基本情報
     - 今日の日柱情報
   - 友達コンテキスト
     - 基本情報（名前、五行属性、日主）
     - 四柱情報
     - 格局情報
     - 用神情報
     - 五行バランス情報
     - 職業や役割情報
   - 運勢コンテキスト
     - 日付情報（今日/明日）
     - 運勢アドバイス（名言を含む）
     - 運勢スコア
     - ラッキーアイテム情報

5. **統合とテスト**
   - コンポーネント単体テスト
   - 統合テスト
   - エンドツーエンドテスト
   - 異なるコンテキストの組み合わせテスト
     - 友達コンテキストのみ
     - 運勢コンテキストのみ
     - 友達 + 運勢の組み合わせ

6. **廃止コードの削除**
   - `ChatModeSelector`コンポーネントの完全削除
   - `ChatMode`列挙型とそれを参照するすべてのコードの削除
   - モードベースの古いAPIエンドポイントとコントローラーの削除
   - チーム目標とチームメンバー相性関連のコードの削除（不要部分）

## 12. 技術的負債への対応

この変更を機に対応すべき技術的負債：

1. **チャットモード列挙型への依存**
   - 固定的なモード定義を完全に削除
   - コンテキストベースの柔軟なシステムへの完全移行

2. **プロンプト生成ロジックの改善**
   - より模範的なパターンマッチングや文字列置換ロジックの導入
   - テンプレートリテラルの活用

3. **API通信の一貫性向上**
   - エラーハンドリングの統一
   - レスポンス形式の標準化

この新しいコンテキスト管理システムの実装により、ユーザーはより柔軟でインタラクティブなチャット体験を得られるようになります。自分の四柱推命情報と今日の日柱情報を常に基本コンテキストとして持ちながら、必要に応じて友達情報や運勢情報を追加することで、より高度で状況に応じた占術アドバイスを受けることができます。