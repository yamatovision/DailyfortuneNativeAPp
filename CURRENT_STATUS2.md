# DailyFortuneネイティブアプリ移行チェックリスト

## 初期設定・環境構築
- [x] 1. 新規プロジェクト作成 (`DailyFortune-Native`)
- [x] 2. 不要ファイル削除 (.git, node_modules など)
- [x] 3. Git リポジトリ初期化
- [x] 4. package.json の名前を `dailyfortune-native` に更新
- [x] 5. README と関連ドキュメントの更新

## Capacitor導入
- [x] 6. Capacitor Core と CLI をインストール
- [x] 7. Capacitor プロジェクト初期化 (`npx cap init`)
- [x] 8. vite.config.ts の base を `'./'` に変更
- [x] 9. Capacitor Preferences パッケージをインストール
- [x] 10. npm run build の実行
- [x] 11. Android プラットフォーム追加 (`npx cap add android`)
- [x] 12. iOS プラットフォーム追加 (`npx cap add ios`)
- [x] 13. capacitor.config.ts の設定

## API設定と環境変数
- [x] 14. 本番環境用API URL設定
- [x] 15. API通信のHTTPS強制対応
- [x] 16. バックエンドのCORS設定確認・調整

## ストレージシステム実装
- [x] 17. IStorageService インターフェース作成
- [x] 18. CapacitorStorageService 実装 (Preferences 使用)
- [x] 19. WebStorageService 実装 (localStorage バックアップ)
- [x] 20. プラットフォーム検出ロジック実装

## 認証システム対応
- [x] 21. token.service.ts の非同期対応
- [x] 22. AuthContext の非同期対応
- [x] 23. ローディング状態の適切な管理実装
- [x] 24. 認証関連の全コンポーネント更新
  - [x] 24.1. ログイン関連画面（Register, ForgotPassword）
  - [x] 24.2. ユーザーメニュー・ナビゲーション（UserMenu, NavigationMenu）
  - [x] 24.3. プロファイル関連コンポーネント（SajuProfileModal, SajuProfileSection）
  - [x] 24.4. チーム関連コンポーネント（Team pages）
  - [x] 24.5. その他認証利用コンポーネント（Fortune, Chat）
  - [x] 24.6. auth-manager.service.ts の非同期対応  
- [x] 25. JWT更新ロジックの非同期対応
- [x] 26. ログイン・ログアウトフローのテスト
- [x] 27. セッション管理の最適化

## ネットワーク監視実装
- [x] 28. NetworkMonitorService の作成
- [x] 29. プラットフォーム別ネットワーク検出実装
- [x] 30. ネットワーク状態表示コンポーネント作成
- [x] 31. オフライン状態時の UI フィードバック実装

## APIサービスのオフライン対応 (基本)
- [ ] 32. GET リクエストのキャッシュシステム実装
- [ ] 33. キャッシュのタイムスタンプと有効期限管理
- [ ] 34. キャッシュのクリア機能実装
- [ ] 35. オフライン読み取り時のキャッシュフォールバック実装
- [ ] 36. オンライン復帰時のキャッシュ再検証ロジック

## UI/UXのモバイル最適化
- [ ] 37. ボタンサイズとタッチターゲット拡大
- [ ] 38. フォントサイズと余白の調整
- [ ] 39. スクロール動作の最適化
- [ ] 40. フォーム入力のモバイル最適化
- [ ] 41. キーボード表示時の UI 調整
- [ ] 42. スプラッシュスクリーン設定
- [ ] 43. アプリアイコン設定
- [ ] 44. ナビゲーションの最適化（スワイプ操作等）
- [ ] 45. モバイル向けローディングインジケーター調整

## プラットフォーム固有設定
- [ ] 46. Android マニフェスト設定（権限など）
- [x] 47. iOS Info.plist 設定（権限など）
- [ ] 48. Android アイコンセット準備（各解像度）
- [ ] 49. iOS アイコンセット準備（各解像度）
- [ ] 50. Android スプラッシュ画像準備
- [ ] 51. iOS スプラッシュ画像準備
- [ ] 52. Android キーボード設定
- [ ] 53. iOS キーボード設定

## アプリ基本機能実装
- [ ] 54. バックボタン処理の実装
- [ ] 55. アプリ終了処理の実装
- [ ] 56. ディープリンク基本設定
- [ ] 57. スクリーン方向設定（縦横）
- [ ] 58. App.tsx のライフサイクル処理調整
- [ ] 59. エラーバウンダリの実装
- [ ] 60. クラッシュレポート基本設定

## ビルド設定
- [ ] 61. Android ビルド設定（build.gradle）
- [ ] 62. iOS ビルド設定（Xcode project）
- [ ] 63. Android リリース用署名Keystore作成
- [ ] 64. iOS 証明書とプロビジョニングプロファイル設定
- [ ] 65. ビルド環境変数の設定
- [ ] 66. ビルドスクリプト作成

## テスト環境
- [ ] 67. Android デバッグビルドの生成と動作確認
- [ ] 68. iOS デバッグビルドの生成と動作確認
- [ ] 69. 複数デバイスでのレイアウトテスト
- [ ] 70. オフライン⇔オンライン切り替えテスト
- [ ] 71. ローカルストレージの動作確認
- [ ] 72. 主要機能の動作確認テスト（運勢表示、プロフィール設定等）
- [ ] 73. 各画面遷移のテスト
- [ ] 74. フォーム送信とバリデーションテスト

## 配布準備
- [ ] 75. App Store Connect アカウント設定
- [ ] 76. Google Play Console アカウント設定
- [ ] 77. App Storeスクリーンショット準備（各デバイスサイズ）
- [ ] 78. Google Playスクリーンショット準備（各デバイスサイズ）
- [ ] 79. アプリ説明文の準備
- [ ] 80. プライバシーポリシーの調整
- [ ] 81. アプリのカテゴリとレーティング設定
- [ ] 82. TestFlight の設定 (iOS)
- [ ] 83. Firebase App Distribution の設定 (Android)
- [ ] 84. テスター向けガイド作成

## リリースビルド
- [ ] 85. バージョン番号と識別子の設定
- [ ] 86. デバッグコードの削除
- [ ] 87. リリース用APIエンドポイント設定
- [ ] 88. Android リリースビルド生成
- [ ] 89. iOS リリースビルド生成
- [ ] 90. リリースビルドの最終動作確認

## CI/CD
- [ ] 91. GitHub Actions ワークフロー設定
- [ ] 92. 自動ビルドの設定
- [ ] 93. 自動テストの設定
- [ ] 94. テスト配布の自動化

## 最終確認
- [ ] 95. アプリ起動・終了サイクルテスト
- [ ] 96. メモリ使用量チェック
- [ ] 97. バッテリー消費テスト
- [ ] 98. 初回起動時の動作確認
- [ ] 99. アプリ再インストール後の動作確認
- [ ] 100. すべての主要機能の最終確認
- [ ] 101. 設定・環境値の最終確認

## 配布とモニタリング
- [ ] 102. App Storeへの提出
- [ ] 103. Google Playへの提出
- [ ] 104. レビュープロセスの監視
- [ ] 105. 初期ユーザーフィードバックの収集準備

# 更新ルール

1. タスク完了時：
   - タスク番号の横にある `[ ]` を `[x]` に変更
   - 完了したタスクに関するエラーログがあれば削除
   - 進捗管理セクションの完了タスク数と進捗率を更新
   - 最終更新日を更新

2. エラー発生時：
   - エラー引き継ぎログに構造化された情報を追加
   - 参考資料があればリンクを追加

3. タスク開始時：
   - 着手中のタスクを明示するため `[ ]` を `[~]` に変更（任意）

## 進捗管理
- 完了タスク数: 38/105
- 進捗率: 36.19%
- 最終更新日: 2025/4/17

## 開発コマンド集

### TypeScriptエラーチェック
```bash
# TypeScriptコンパイルエラーチェック（コード生成なし）
cd client && npx tsc --noEmit

# プロジェクトビルド（エラーチェック込み）
cd client && npm run build
```

### アプリ起動
```bash
# 開発サーバー起動（ローカルのみ）
cd client && npm run dev

# 開発サーバー起動（外部アクセス可能）
cd client && npm run dev -- --host

# iOS向けビルドと同期
cd client && npm run build && npx cap sync ios

# Android向けビルドと同期
cd client && npm run build && npx cap sync android
```

### テスト実行
```bash
# ネイティブプロジェクトをXcodeで開く
cd client && npx cap open ios

# ネイティブプロジェクトをAndroid Studioで開く
cd client && npx cap open android
```

## 参考資料リンク

- [ネイティブアプリ実装ガイド](/docs/native-app-implementation-guide.md) - Capacitorを使った実装の詳細ガイド
- [ネイティブアプリ移行計画](/docs/native-app-migration-plan.md) - 移行全体の計画書
- [Capacitor公式ドキュメント](https://capacitorjs.com/docs) - Capacitorの公式リファレンス
- [Vite+React+TypeScript構成](https://vitejs.dev/guide/) - ビルド設定の参考

## エラー引き継ぎログ

このセクションには、タスク実行中に発生した問題とその解決策を記録します。タスクが完了したら、そのタスクに関するログは削除して構いません。

### 記録形式

```
【タスク番号】タスク名
- 問題：遭遇した問題の詳細
- 試行：試行した解決策
- 結果：成功または失敗、部分的な成功
- 解決策：最終的な解決策または回避策
- メモ：引き継ぎに必要な追加情報
- 参考：関連する参考資料へのリンク（任意）
```

### 現在のエラーログ

【26】ログイン・ログアウトフローのテスト
- 問題：iOSシミュレータ上でバックエンドAPIサーバーに直接接続し、フロントエンドUI（ログイン画面）が表示されなかった
- 試行1：capacitor.config.tsでバックエンドAPI接続先を指定
- 結果1：API JSON応答は表示されるがUIは表示されない
- 試行2：capacitor.config.tsでフロントエンド開発サーバー接続先を指定
- 結果2：接続エラーが発生
- 試行3：HTTPトラフィック許可の追加と開発サーバー--host設定
- 結果3：成功。フロントエンド開発サーバーに接続しログイン画面が表示された
- 解決策：
  1. capacitor.config.tsで開発サーバーURLと安全でない接続を許可する設定を追加
  2. iOS Info.plistにNSAppTransportSecurityを追加しHTTP接続を許可
  3. 開発サーバーを--hostフラグで起動し外部アクセスを許可
- メモ：Capacitorアプリのテスト時は開発サーバーをIPアドレスで公開する必要がある
- 参考：https://capacitorjs.com/docs/basics/configuring-your-app

【27】セッション管理の最適化
- 問題：アプリのバックグラウンド/フォアグラウンド切り替え時にセッション状態が適切に管理されていない
- 試行1：AuthContextでのトークン更新ロジックを見直し
- 結果1：複数のタイマーが重複して動作し、トークン更新が頻繁に発生
- 試行2：Capacitor Appプラグインを導入し専用のセッションマネージャーを実装
- 結果2：成功。アプリライフサイクルイベントと連動したセッション管理を実現
- 解決策：
  1. Capacitor Appプラグインをインストール・設定
  2. session-manager.serviceを実装してアプリライフサイクルを検出
  3. トークン更新最適化（バックグラウンド時は更新しない）
  4. App.tsxからセッションマネージャーを初期化
- メモ：Web環境とネイティブ環境の両方でライフサイクルイベントを適切に処理する必要がある
- 参考：https://capacitorjs.com/docs/apis/app